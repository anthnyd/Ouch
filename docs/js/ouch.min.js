var connection,actions,timeout,header=document.getElementById("header"),exist_input=document.getElementById("exist-input"),user_input=document.getElementById("user-input"),chat=document.getElementById("chat"),leaderboard=document.getElementsByClassName("leaderboard")[0],level=document.getElementById("level"),box=document.getElementById("box"),search=document.getElementById("search"),ouch=document.getElementById("ouch"),submit_button=document.getElementById("submit-button"),reconnect_button=document.getElementById("reconnect-button"),help=document.getElementById("help"),indicator=document.getElementById("indicator"),world_value=document.getElementById("world-value"),loading=document.getElementById("loading"),commands=document.getElementById("commands"),chatindic=document.getElementById("chat-indic"),helpicon=document.getElementById("help-icon"),search_items=document.getElementsByClassName("search-item"),login=!1,enteredOnce=!1,nickname="user",id="id",allowedInput=/^[a-z0-9]+$/i,url_base="sim-ouch.herokuapp.com",url_ws="wss://"+url_base+"/ws",url_actions="https://"+url_base+"/actions",reconnect_token=null,close_code={ER_NO_NAME:4005,ER_EX_NOT_FOUND:4004,ER_Q_NOT_FOUND:4040,ER_BAD_TOKEN:4007,ER_INTERNAL_GENERIC:4010},ping_packet='{"dataType":"PING","data":"PING"}',usr_disconnected=!1,reconnecting=!1,testActions=["-bean","-exit","-theme"],searching=!1,here=!0,inactive=3e4;function switchState(){null!=reconnect_token?reconnect_button.classList.toggle("hidden"):submit_button.classList.toggle("hidden"),box.classList.toggle("opacity"),user_input.classList.toggle("login"),exist_input.classList.toggle("login"),header.classList.toggle("login"),exist_input.classList.toggle("opacity"),exist_input.classList.toggle("disappear"),level.classList.toggle("opacity"),leaderboard.classList.toggle("opacity"),login=!login}function switchSearch(){search.classList.toggle("opacity"),search.classList.toggle("disappear"),chat.classList.toggle("opacity"),chat.classList.toggle("disappear"),searching=!searching}function switchDark(){ouch.classList.toggle("dark"),header.classList.toggle("dark"),chat.classList.toggle("dark")}function togglePopUp(){help.classList.toggle("opacity")}function switchLoading(e){e?(commands.classList.toggle("opacity"),setTimeout(function(){loading.classList.toggle("disappear"),loading.classList.toggle("opacity")},1e3)):(loading.classList.toggle("opacity"),loading.classList.toggle("disappear"),setTimeout(function(){commands.classList.toggle("opacity")},1e3))}function switchChatIndic(){chatindic.classList.toggle("disappear"),chatindic.classList.toggle("opacity")}var bottom=function(){chat.scrollTop=chat.scrollHeight};function scrollBottom(){console.log(0+prevChatSize+" "+chat.offsetTop),chat.scrollTop===prevChatSize&&.2*document.documentElement.clientWidth<chat.scrollHeight||chat.scrollHeight<0||switchChatIndic(),prevChatSize=chat.scrollHeight}function shake(e){e.classList.add("shake"),setTimeout(function(){e.classList.remove("shake")},1e3)}function reset(){switchState(),indicator.classList.toggle("connected"),world_value.innerHTML="offline",leaderboard.innerHTML="",chat.innerHTML="",user_input.value="",user_input.placeholder="username",enteredOnce=!1,ouch.innerHTML="Ouch",searching&&switchSearch()}function addChat(e,t,n){var c="";"system"===n?c='<div class="chat-msg-cont"><p class="chat-msg system"><span style="font-weight: bold;">'+e+"</span> "+t+"</p></div>":e!==nickname&&"client"===n?c='<div class="chat-msg-cont"><p class="chat-msg '+n+'"><span style="font-weight: bold;">'+e+": </span>"+t+"</p></div>":e===nickname&&"client"===n&&(c='<div class="chat-msg-cont"><p class="chat-msg user">'+t+"</p></div>"),chat.innerHTML+=c}function chatIndic(){scrollBottom(),bottom()}function makeChatMessage(e){return'{"dataType":"CHAT","data":"'+e+'"}'}function handleInit(e){var t=e.existence,n=e.quiddity;reconnect_token=e.token,level.innerHTML=n.name+'<span id="world-value" style="font-weight: normal;"> '+n.ouch.degree+"</span>",world_value.innerHTML=e.existence._id,user_input.placeholder="enter command or message",indicator.classList.toggle("await"),indicator.classList.toggle("connected");var c=t.quidities;for(var o in c)leaderboard.innerHTML+='<div class="data-leaderboard-cont"><p class="data-leaderboard '+c[o].id+'">'+c[o].name+' <span class="normal">'+c[o].ouch.degree+"</span></p></div>";for(var a=t.chat.history,s=0;s<a.length;s++){var i=a[s];addChat(i.authorName,i.content,"client")}setTimeout(function(){switchLoading(!1)},1e3)}function heartbeat(){connection&&1===connection.readyState&&here&&(connection.send(ping_packet),setTimeout(heartbeat,29e3))}function createConnection(e){switchLoading(!0),inactivityTime(),(connection=new WebSocket(e)).onopen=function(){switchState(),indicator.classList.toggle("await"),world_value.innerHTML="connecting",user_input.value="",user_input.placeholder="connecting to the Existence...",heartbeat()},connection.onerror=function(e){alert("WebSocket error:"+e)},connection.onmessage=function(e){var t=JSON.parse(e.data),n=JSON.parse(t.data);switch(t.dataType){case"INIT":handleInit(n);break;case"CHAT":addChat(n.authorName,n.content,"client"),scrollBottom();break;case"ENTER":leaderboard.innerHTML+='<div class="data-leaderboard-cont"><p class="data-leaderboard '+n.id+'">'+n.name+' <span class="normal">'+n.ouch.degree+"</span></p></div>",addChat(n.name,"has joined the Existence.","system"),scrollBottom();break;case"EXIT":var c=document.getElementsByClassName(n.id)[0];c.parentNode.removeChild(c),addChat(n.name,"has left the Existence.","system"),scrollBottom();break;case"PING":break;default:console.log("Unknown dataType"),console.log(e.data)}},connection.onclose=function(e){switch(reset(),e.code){case close_code.ER_NO_NAME:shake(user_input);break;case close_code.ER_BAD_ID:exist_input.value="",exist_input.placeholder="Unknown ID",user_input.value=nickname,shake(exist_input);break;case close_code.ER_INTERNAL_GENERIC:alert("Sorry, an internal error occurred. Please try again");break;case close_code.ER_BAD_TOKEN:reconnect_token=null;break;default:if(!usr_disconnected){reconnect_button.onclick();break}usr_disconnected=!1}here=!1}}function getHTTP(e){fetch(e).then(function(e){e.json()}).then(function(e){return e})}function loadActions(){var e=makeHttpObject();e.open("GET",url_actions,!0),e.send(null),e.onreadystatechange=function(){4==e.readyState&&alert(e.responseText)}}function makeHttpObject(){try{return new XMLHttpRequest}catch(e){}try{return new ActiveXObject("Msxml2.XMLHTTP")}catch(e){}try{return new ActiveXObject("Microsoft.XMLHTTP")}catch(e){}throw new Error("Could not create HTTP request object.")}function inactivityTime(){window.onload=resetTimer,document.onmousemove=resetTimer,document.onkeypress=resetTimer}function timedOut(){usr_disconnected=!(here=!1),connection.close()}function resetTimer(){clearTimeout(timeout),here=!0,timeout=setTimeout(timedOut,inactive)}function processInput(e){if(here=!0,13===event.key||"Enter"===event.key||!0===e){var t=user_input.value;if(login){if(""===t||!t.match(allowedInput))return shake(user_input),!1;if(!enteredOnce)return!0}else event.preventDefault(),""===t?shake(user_input):"-"===t.charAt(0)?processCommands(t):1==connection.readyState?connection.send(makeChatMessage(t)):console.log("web socket is not connected"),user_input.value=""}}function processCommands(e){switch(e){case"-theme":switchDark();break;case"-bean":ouch.innerHTML='<object data="imgs/bean.svg" type="image/svg+xml" style="width: 200px;"></object>';break;case"-exit":usr_disconnected=!0,connection.close();break;default:console.log("action "+e)}}function autocompleteSearch(e){search.innerHTML="";for(var t=0,n=0;n<testActions.length;n++)testActions[n].includes(e)&&(t++,search.innerHTML+='<div class="search-item">'+testActions[n]+"</div>");0===t&&(search.innerHTML+='<div class="search-item">No Matches</div>');for(n=0;n<search_items.length;n++)n!==search_items.length-1&&search_items[n].classList.add("search-bottom-border"),search_items[n].onclick=function(e){autofill(e.target.innerHTML)};searching=!0}function autofill(e){user_input.value="",processCommands(e),switchSearch()}exist_input.addEventListener("keydown",function(e){processInput()&&submit_button.click()}),user_input.addEventListener("keydown",function(e){processInput()&&submit_button.click()}),user_input.addEventListener("keyup",function(e){"-"===user_input.value.charAt(0)?(searching||switchSearch(),login||autocompleteSearch(user_input.value)):searching&&(switchSearch(),searching=!1)}),reconnect_button.onclick=function(){reconnecting=!0,createConnection(url_ws+"?token="+reconnect_token)},submit_button.onclick=function(){nickname=user_input.value,id=exist_input.value,processInput(!0)&&(""===id?(enteredOnce=!0,createConnection(url_ws+"?name="+nickname)):(enteredOnce=!0,createConnection(url_ws+"?name="+nickname+"&exID="+id.toUpperCase())))},document.getElementsByClassName("close")[0].onclick=function(){togglePopUp(),setTimeout(function(){help.classList.add("zindex")},1e3)},helpicon.onclick=function(){help.classList.remove("zindex"),togglePopUp()},document.onbeforeunload=function(){connection.close()},window.onload=function(){loadActions()};